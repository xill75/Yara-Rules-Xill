import "pe"
import "hash"


rule Malware_PyInstaller_Zstd_ShellCodeLoader
{
    meta:
        author = "Felipe Schiel"
        date = "2025-08-07"
        description = "Detecta um loader malicioso empacotado com PyInstaller que usa um intérprete de bytecode customizado e descompressão Zstandard para executar um shellcode.O payload do bytecode é armazenado em um recurso RCDATA."
        hash = "c4a8e88fdfffedd5dc859b1999f82e3d3427e87f66f6777b874184e11fe78133"
        version = "1.0"

    strings:
      
        $pyi1 = "_MEIPASS" ascii
        $pyi2 = "pyi_carchive" ascii
        $pyi3 = "pyiboot01_bootstrap" ascii
        $pyi4 = "zipextimporter" ascii

       
        $zstd1 = "uzstandard.ZstdDecompressor" ascii
        $zstd2 = "ZstdError" ascii
        $zstd3 = "Decompress a zstd frame" ascii
        
       
        $bytecode_header = { D2 F0 7B C1 C5 46 7B 00 }

    condition:
        
        uint16(0) == 0x5A4D and 
        filesize < 20MB and 
        pe.is_dll() and



        $bytecode_header or
    
        1 of ($zstd*) or
        2 of ($pyi*)
}